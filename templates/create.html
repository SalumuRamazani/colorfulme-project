{% extends "base.html" %}

{% block title %}Create Coloring Pages | ColorfulMe{% endblock %}
{% block description %}Generate printable coloring pages from prompts and photos with ColorfulMe.{% endblock %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
  <div class="grid lg:grid-cols-[1.1fr_0.9fr] gap-6 lg:gap-8">
    <div class="glass rounded-3xl border border-blue-100 p-6 sm:p-7">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h1 class="font-display text-3xl font-bold">Create Coloring Page</h1>
        <span class="chip rounded-full px-3 py-1 text-xs font-semibold">Text • Photo • Recolor</span>
      </div>

      <div class="mt-6 space-y-5">
        <div>
          <label class="text-sm font-medium text-slate-700">Generation Mode</label>
          <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
            <button type="button" data-mode-btn="text" class="mode-btn rounded-lg border border-blue-200 bg-blue-50 text-blue-700 px-3 py-2 font-semibold">Text</button>
            <button type="button" data-mode-btn="photo" class="mode-btn rounded-lg border border-slate-200 bg-white text-slate-600 px-3 py-2 font-semibold">Photo</button>
            <button type="button" data-mode-btn="recolor" class="mode-btn rounded-lg border border-slate-200 bg-white text-slate-600 px-3 py-2 font-semibold">Recolor</button>
          </div>
        </div>

        <div>
          <label for="prompt" class="text-sm font-medium text-slate-700">Prompt</label>
          <textarea id="prompt" rows="4" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Example: A friendly dragon flying over a mountain village with clouds"></textarea>
          <p class="mt-1 text-xs text-slate-500">Family-safe prompts only. Unsafe prompts are blocked.</p>
        </div>

        <div id="source-wrap" class="hidden">
          <label for="source-image" class="text-sm font-medium text-slate-700">Source Image</label>
          <input id="source-image" type="file" accept="image/png,image/jpeg,image/webp" class="mt-2 w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
          <p class="mt-1 text-xs text-slate-500">Used in Photo mode and optional in Recolor mode.</p>
        </div>

        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <label for="style" class="text-sm font-medium text-slate-700">Style</label>
            <select id="style" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2">
              <option value="clean line art">Clean Line Art</option>
              <option value="thick outlines">Thick Outlines</option>
              <option value="storybook">Storybook</option>
              <option value="minimal geometric">Minimal Geometric</option>
            </select>
          </div>
          <div>
            <label for="aspect-ratio" class="text-sm font-medium text-slate-700">Aspect Ratio</label>
            <select id="aspect-ratio" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2">
              <option value="1:1">1:1</option>
              <option value="4:5">4:5</option>
              <option value="3:4">3:4</option>
              <option value="16:9">16:9</option>
              <option value="9:16">9:16</option>
            </select>
          </div>
          <div>
            <label for="difficulty" class="text-sm font-medium text-slate-700">Difficulty</label>
            <select id="difficulty" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2">
              <option value="easy">Easy</option>
              <option value="standard">Standard</option>
              <option value="detailed">Detailed</option>
            </select>
          </div>
        </div>

        <button id="generate-btn" class="w-full px-4 py-3 rounded-xl btn-primary font-semibold text-base transition">Generate Coloring Page</button>
        <p id="generator-status" class="text-sm text-slate-600 min-h-[1.25rem]"></p>
      </div>
    </div>

    <div class="space-y-6">
      <div class="glass rounded-3xl border border-blue-100 p-6">
        <h2 class="font-display text-xl font-bold">Result</h2>
        <div id="result-empty" class="mt-4 rounded-2xl border border-dashed border-blue-300 bg-white/70 text-slate-500 text-sm p-8 text-center">Your generated page will appear here.</div>
        <div id="result-card" class="hidden mt-4">
          <div class="rounded-2xl border border-blue-100 bg-white p-3">
            <img id="result-image" alt="Generated coloring page" class="w-full rounded-xl bg-white object-contain max-h-[520px]">
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <a id="download-png" href="#" class="px-4 py-2 rounded-xl btn-secondary text-center font-medium">Download PNG</a>
            <a id="download-pdf" href="#" class="px-4 py-2 rounded-xl btn-primary text-center font-medium">Download PDF</a>
          </div>
          <p id="result-meta" class="mt-3 text-xs text-slate-500"></p>
        </div>
      </div>

      <div class="glass rounded-3xl border border-blue-100 p-6">
        <h3 class="font-display text-lg font-bold">Credit Costs</h3>
        <ul class="mt-3 space-y-2 text-sm text-slate-600">
          <li>Text generation: <strong>1 credit</strong></li>
          <li>Photo conversion: <strong>2 credits</strong></li>
          <li>Recolor transform: <strong>1 credit</strong></li>
          <li>PDF download: <strong>0 credits</strong></li>
        </ul>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const modeButtons = document.querySelectorAll('.mode-btn');
  const sourceWrap = document.getElementById('source-wrap');
  const statusEl = document.getElementById('generator-status');
  const generateBtn = document.getElementById('generate-btn');
  const resultEmpty = document.getElementById('result-empty');
  const resultCard = document.getElementById('result-card');
  const resultImage = document.getElementById('result-image');
  const downloadPng = document.getElementById('download-png');
  const downloadPdf = document.getElementById('download-pdf');
  const resultMeta = document.getElementById('result-meta');

  let currentMode = 'text';

  function setMode(mode) {
    currentMode = mode;
    modeButtons.forEach((btn) => {
      const active = btn.dataset.modeBtn === mode;
      btn.classList.toggle('bg-blue-50', active);
      btn.classList.toggle('text-blue-700', active);
      btn.classList.toggle('border-blue-200', active);
      btn.classList.toggle('bg-white', !active);
      btn.classList.toggle('text-slate-600', !active);
      btn.classList.toggle('border-slate-200', !active);
    });
    sourceWrap.classList.toggle('hidden', mode === 'text');
  }

  modeButtons.forEach((btn) => {
    btn.addEventListener('click', () => setMode(btn.dataset.modeBtn));
  });

  async function loadBlobAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function generate() {
    const prompt = document.getElementById('prompt').value.trim();
    const style = document.getElementById('style').value;
    const aspectRatio = document.getElementById('aspect-ratio').value;
    const difficulty = document.getElementById('difficulty').value;

    const payload = {
      prompt,
      style,
      aspect_ratio: aspectRatio,
      difficulty,
    };

    if (currentMode !== 'text') {
      const sourceFile = document.getElementById('source-image').files[0];
      if (sourceFile) {
        payload.source_image_base64 = await loadBlobAsDataURL(sourceFile);
      }
    }

    statusEl.textContent = 'Generating...';
    generateBtn.disabled = true;
    generateBtn.classList.add('opacity-70');

    try {
      const response = await fetch(`/api/v1/generations/${currentMode}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.error || data.job?.error_message || 'Generation failed');
      }

      if (!data.job || !data.job.asset) {
        throw new Error('Generation did not return an asset');
      }

      const asset = data.job.asset;
      resultImage.src = asset.png_url;
      downloadPng.href = `/api/v1/assets/${asset.asset_id}/download?format=png`;
      downloadPdf.href = `/api/v1/assets/${asset.asset_id}/download?format=pdf`;
      resultMeta.textContent = `Job ${data.job_id} • ${data.status} • Credits used: ${data.credits_used}`;

      resultEmpty.classList.add('hidden');
      resultCard.classList.remove('hidden');
      statusEl.textContent = 'Done. Your coloring page is ready.';
    } catch (error) {
      statusEl.textContent = error.message;
      if (error.message.toLowerCase().includes('authentication')) {
        const modal = document.getElementById('auth-modal');
        if (modal) modal.classList.add('open');
      }
    } finally {
      generateBtn.disabled = false;
      generateBtn.classList.remove('opacity-70');
    }
  }

  generateBtn.addEventListener('click', generate);
</script>
{% endblock %}
