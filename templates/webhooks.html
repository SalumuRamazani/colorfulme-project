{% extends "base.html" %}

{% block title %}Webhook Integrations - ReceiptMake{% endblock %}

{% block content %}
<div class="min-h-screen bg-neutral-50 py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-neutral-900">Webhook Integrations</h1>
            <p class="text-neutral-600 mt-2">Connect external services bi-directionally</p>
        </div>
        
        <!-- INCOMING WEBHOOKS - Receive data FROM external services -->
        <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-neutral-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                        </svg>
                        Incoming Webhooks
                    </h2>
                    <p class="text-neutral-600 mt-1 text-sm">Allow external services to send data TO ReceiptMake</p>
                </div>
            </div>
            
            <div id="incomingWebhookSection" class="bg-white border border-neutral-200 rounded-xl p-6">
                <div id="incomingWebhookLoading" class="text-center py-4">
                    <svg class="animate-spin inline-block w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-neutral-600 mt-2">Loading...</p>
                </div>
                
                <div id="incomingWebhookContent" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-2">Your Webhook URL</label>
                        <div class="flex gap-2">
                            <input type="text" id="incomingWebhookUrl" readonly class="flex-1 px-3 py-2 border border-neutral-300 rounded-lg bg-neutral-50 text-neutral-800 font-mono text-sm" value="">
                            <button onclick="copyToClipboard('incomingWebhookUrl')" class="px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition font-medium">
                                Copy
                            </button>
                        </div>
                        <p class="text-xs text-neutral-500 mt-1">Share this URL with services like outrank.so to receive data</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-neutral-700 mb-2">API Key</label>
                        <div class="flex gap-2">
                            <input type="text" id="incomingApiKey" readonly class="flex-1 px-3 py-2 border border-neutral-300 rounded-lg bg-neutral-50 text-neutral-800 font-mono text-sm" value="••••••••">
                            <button onclick="rotateApiKey()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition font-medium">
                                Regenerate
                            </button>
                        </div>
                        <p class="text-xs text-neutral-500 mt-1">Services must include this in the Authorization header: <code class="bg-neutral-100 px-1 rounded">Authorization: Bearer YOUR_API_KEY</code></p>
                    </div>
                    
                    <div class="flex items-center justify-between pt-4 border-t border-neutral-200">
                        <div>
                            <p class="text-sm font-medium text-neutral-700">Status</p>
                            <p class="text-xs text-neutral-500" id="webhookStatusText">Active</p>
                        </div>
                        <button onclick="toggleIncomingWebhook()" id="toggleIncomingBtn" class="px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200 transition font-medium">
                            Disable
                        </button>
                    </div>
                    
                    <!-- Incoming Webhook History -->
                    <div class="pt-6 border-t border-neutral-200 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-neutral-900">Recent Events</h3>
                            <button onclick="refreshHistory()" class="text-sm text-blue-600 hover:text-blue-800">Refresh</button>
                        </div>
                        <div id="historyContainer" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-sm text-neutral-500 text-center py-4">Loading history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- OUTGOING WEBHOOKS - Send data TO external services -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-neutral-900 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                        Outgoing Webhooks
                    </h2>
                    <p class="text-neutral-600 mt-1 text-sm">Send receipt data TO external services automatically</p>
                </div>
                <button onclick="showCreateModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Webhook
                </button>
            </div>
        </div>

        {% if webhooks %}
            <div class="space-y-4">
                {% for webhook in webhooks %}
                <div class="bg-white border border-neutral-200 rounded-xl p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold text-neutral-900">{{ webhook.name }}</h3>
                                <span class="px-2 py-1 text-xs rounded-full {% if webhook.is_active %}bg-green-100 text-green-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {% if webhook.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </div>
                            <p class="text-sm text-neutral-600 mb-2">{{ webhook.endpoint_url }}</p>
                            <div class="flex items-center gap-4 text-xs text-neutral-500">
                                <span>Created {{ webhook.created_at.strftime('%B %d, %Y') }}</span>
                                {% if webhook.last_triggered %}
                                <span>Last triggered {{ webhook.last_triggered.strftime('%B %d, %Y at %I:%M %p') }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleWebhook({{ webhook.id }})" class="p-2 text-neutral-600 hover:bg-neutral-100 rounded-lg transition" title="Toggle active status">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </button>
                            <button onclick="deleteWebhook({{ webhook.id }})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Delete webhook">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="bg-white border border-neutral-200 rounded-xl p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-neutral-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-neutral-900 mb-2">No webhooks configured</h3>
                <p class="text-neutral-600 mb-6">Add your first webhook to start receiving receipt data automatically</p>
                <button onclick="showCreateModal()" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Webhook
                </button>
            </div>
        {% endif %}

        <div class="mt-8 pt-6 border-t border-neutral-200">
            <a href="{{ url_for('dashboard') }}" class="text-blue-600 hover:text-blue-800 font-medium">
                ← Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Create Webhook Modal -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="p-6 border-b border-neutral-200">
            <h2 class="text-xl font-semibold text-neutral-900">Add Webhook Integration</h2>
        </div>
        <form id="webhookForm" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Integration Name *</label>
                <input type="text" id="webhookName" required class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="My Webhook Integration">
            </div>
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Webhook Endpoint *</label>
                <input type="url" id="webhookEndpoint" required class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://api.example.com/webhook">
            </div>
            <div>
                <label class="block text-sm font-medium text-neutral-700 mb-2">Access Token</label>
                <input type="text" id="webhookToken" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Your Access Token">
                <p class="text-xs text-neutral-500 mt-1">Optional. Will be sent as Bearer token in Authorization header.</p>
            </div>
            
            <div class="border-t border-neutral-200 pt-4">
                <label class="block text-sm font-medium text-neutral-700 mb-2">Test Your Webhook</label>
                <p class="text-xs text-neutral-500 mb-3">Fill in the webhook endpoint and access token above to enable testing</p>
                <button type="button" onclick="testWebhook()" id="testWebhookBtn" class="w-full px-4 py-2 bg-neutral-100 text-neutral-400 rounded-lg font-medium cursor-not-allowed" disabled>
                    <span id="testBtnText">Send Test</span>
                    <svg id="testBtnSpinner" class="hidden animate-spin inline-block w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <div id="testResult" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
            </div>
        </form>
        <div class="p-6 border-t border-neutral-200 flex justify-end gap-3">
            <button onclick="hideCreateModal()" class="px-4 py-2 text-neutral-700 hover:bg-neutral-100 rounded-lg transition font-medium">
                Cancel
            </button>
            <button onclick="createWebhook()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                Create Webhook
            </button>
        </div>
    </div>
</div>

<script>
function showCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
}

function hideCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.getElementById('webhookForm').reset();
    document.getElementById('testResult').classList.add('hidden');
    enableTestButton(false);
}

// ===========================================
// INCOMING WEBHOOKS
// ===========================================

let incomingWebhookConfig = null;

// Initialize incoming webhook on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Initialize outgoing webhook test button
    const endpointInput = document.getElementById('webhookEndpoint');
    if (endpointInput) {
        endpointInput.addEventListener('input', function() {
            enableTestButton(this.value.trim().length > 0);
        });
    }
    
    // Initialize incoming webhook
    await initializeIncomingWebhook();
});

async function initializeIncomingWebhook() {
    try {
        const response = await fetch('/api/incoming/webhooks/initialize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            incomingWebhookConfig = data;
            
            // Show the content
            document.getElementById('incomingWebhookLoading').classList.add('hidden');
            document.getElementById('incomingWebhookContent').classList.remove('hidden');
            
            // Set the webhook URL
            document.getElementById('incomingWebhookUrl').value = data.webhook_url;
            
            // If this is a new initialization, show the API key
            if (data.api_key) {
                document.getElementById('incomingApiKey').value = data.api_key;
                setTimeout(() => {
                    document.getElementById('incomingApiKey').value = '••••••••' + data.api_key_hint;
                }, 10000); // Hide after 10 seconds
            } else {
                document.getElementById('incomingApiKey').value = '••••••••' + data.api_key_hint;
            }
            
            // Load history
            await refreshHistory();
        }
    } catch (error) {
        console.error('Error initializing incoming webhook:', error);
        document.getElementById('incomingWebhookLoading').innerHTML = '<p class="text-red-600">Error loading webhook configuration</p>';
    }
}

// Escape HTML to prevent XSS
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

async function refreshHistory() {
    try {
        const response = await fetch('/api/incoming/webhooks/history');
        const data = await response.json();
        
        const container = document.getElementById('historyContainer');
        container.innerHTML = ''; // Clear first
        
        if (data.events && data.events.length > 0) {
            data.events.forEach(event => {
                const statusColor = event.status === 'success' ? 'green' : (event.status === 'invalid_auth' ? 'red' : 'amber');
                const statusIcon = event.status === 'success' ? '✓' : '✗';
                
                // Create elements using DOM APIs instead of innerHTML
                const eventDiv = document.createElement('div');
                eventDiv.className = 'bg-neutral-50 rounded-lg p-3 hover:bg-neutral-100 transition cursor-pointer';
                eventDiv.onclick = () => viewEventDetails(event);
                
                const topRow = document.createElement('div');
                topRow.className = 'flex items-center justify-between';
                
                const statusGroup = document.createElement('div');
                statusGroup.className = 'flex items-center gap-2';
                
                const icon = document.createElement('span');
                icon.className = `text-${statusColor}-600 font-bold`;
                icon.textContent = statusIcon;
                
                const statusText = document.createElement('span');
                statusText.className = 'text-sm font-medium text-neutral-900';
                statusText.textContent = event.status; // Safe text content
                
                const timestamp = document.createElement('span');
                timestamp.className = 'text-xs text-neutral-500';
                timestamp.textContent = new Date(event.received_at).toLocaleString();
                
                statusGroup.appendChild(icon);
                statusGroup.appendChild(statusText);
                topRow.appendChild(statusGroup);
                topRow.appendChild(timestamp);
                
                const bottomRow = document.createElement('div');
                bottomRow.className = 'mt-1 text-xs text-neutral-600';
                
                const ipSpan = document.createElement('span');
                ipSpan.textContent = 'IP: ' + (escapeHtml(event.ip_address) || 'N/A');
                bottomRow.appendChild(ipSpan);
                
                if (event.error_message) {
                    const errorSpan = document.createElement('span');
                    errorSpan.className = 'ml-2 text-red-600';
                    errorSpan.textContent = event.error_message; // Safe text content
                    bottomRow.appendChild(errorSpan);
                }
                
                eventDiv.appendChild(topRow);
                eventDiv.appendChild(bottomRow);
                container.appendChild(eventDiv);
            });
        } else {
            const emptyMsg = document.createElement('p');
            emptyMsg.className = 'text-sm text-neutral-500 text-center py-4';
            emptyMsg.textContent = 'No events yet';
            container.appendChild(emptyMsg);
        }
    } catch (error) {
        console.error('Error loading history:', error);
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        const errorMsg = document.createElement('p');
        errorMsg.className = 'text-sm text-red-600 text-center py-4';
        errorMsg.textContent = 'Error loading history';
        container.appendChild(errorMsg);
    }
}

function viewEventDetails(event) {
    alert(`Event Details:\n\nStatus: ${event.status}\nReceived: ${new Date(event.received_at).toLocaleString()}\nIP: ${event.ip_address}\n\nPayload:\n${JSON.stringify(event.payload, null, 2)}`);
}

async function rotateApiKey() {
    if (!confirm('Are you sure you want to regenerate your API key? The old key will stop working immediately.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/incoming/webhooks/rotate-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show the new API key temporarily
            document.getElementById('incomingApiKey').value = data.api_key;
            alert('API key rotated successfully! Copy it now - it will be hidden in 10 seconds.');
            
            setTimeout(() => {
                document.getElementById('incomingApiKey').value = '••••••••' + data.api_key_hint;
            }, 10000);
        } else {
            alert('Error rotating API key: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error rotating API key: ' + error.message);
    }
}

async function toggleIncomingWebhook() {
    try {
        const response = await fetch('/api/incoming/webhooks/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const statusText = document.getElementById('webhookStatusText');
            const toggleBtn = document.getElementById('toggleIncomingBtn');
            
            if (data.is_active) {
                statusText.textContent = 'Active';
                toggleBtn.textContent = 'Disable';
            } else {
                statusText.textContent = 'Inactive';
                toggleBtn.textContent = 'Enable';
            }
        } else {
            alert('Error toggling webhook: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error toggling webhook: ' + error.message);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(element.value).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 2000);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

// ===========================================
// OUTGOING WEBHOOKS
// ===========================================

function enableTestButton(enabled) {
    const btn = document.getElementById('testWebhookBtn');
    if (enabled) {
        btn.classList.remove('bg-neutral-100', 'text-neutral-400', 'cursor-not-allowed');
        btn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
        btn.disabled = false;
    } else {
        btn.classList.add('bg-neutral-100', 'text-neutral-400', 'cursor-not-allowed');
        btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
        btn.disabled = true;
    }
}

async function testWebhook() {
    const endpoint = document.getElementById('webhookEndpoint').value;
    const token = document.getElementById('webhookToken').value;
    const resultDiv = document.getElementById('testResult');
    const btnText = document.getElementById('testBtnText');
    const btnSpinner = document.getElementById('testBtnSpinner');
    const btn = document.getElementById('testWebhookBtn');

    if (!endpoint) {
        showTestResult('error', 'Please enter a webhook endpoint URL');
        return;
    }

    // Show loading state
    btn.disabled = true;
    btnText.textContent = 'Sending...';
    btnSpinner.classList.remove('hidden');
    resultDiv.classList.add('hidden');

    try {
        const response = await fetch('/api/test-webhook', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                endpoint_url: endpoint,
                access_token: token 
            })
        });

        const data = await response.json();

        if (data.success) {
            showTestResult('success', `✓ Test successful! Your endpoint responded with status ${data.status_code}`);
        } else {
            showTestResult('error', `✗ Test failed: ${data.error}`);
        }
    } catch (error) {
        showTestResult('error', `✗ Test failed: ${error.message}`);
    } finally {
        // Reset button state
        btn.disabled = false;
        btnText.textContent = 'Send Test';
        btnSpinner.classList.add('hidden');
    }
}

function showTestResult(type, message) {
    const resultDiv = document.getElementById('testResult');
    resultDiv.classList.remove('hidden', 'bg-green-50', 'text-green-800', 'bg-red-50', 'text-red-800');
    
    if (type === 'success') {
        resultDiv.classList.add('bg-green-50', 'text-green-800');
    } else {
        resultDiv.classList.add('bg-red-50', 'text-red-800');
    }
    
    resultDiv.textContent = message;
}

async function createWebhook() {
    const name = document.getElementById('webhookName').value;
    const endpoint_url = document.getElementById('webhookEndpoint').value;
    const access_token = document.getElementById('webhookToken').value;

    if (!name || !endpoint_url) {
        alert('Please fill in all required fields');
        return;
    }

    try {
        const response = await fetch('/webhooks/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, endpoint_url, access_token })
        });

        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Error creating webhook: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error creating webhook: ' + error.message);
    }
}

async function deleteWebhook(webhookId) {
    if (!confirm('Are you sure you want to delete this webhook?')) {
        return;
    }

    try {
        const response = await fetch(`/webhooks/${webhookId}/delete`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Error deleting webhook: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting webhook: ' + error.message);
    }
}

async function toggleWebhook(webhookId) {
    try {
        const response = await fetch(`/webhooks/${webhookId}/toggle`, {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Error toggling webhook: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error toggling webhook: ' + error.message);
    }
}
</script>
{% endblock %}
