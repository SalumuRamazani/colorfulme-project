const scriptCache={};async function loadScript(e){return scriptCache[e]||(scriptCache[e]=new Promise((t,a)=>{const s=document.createElement("script");s.src=e,s.onload=()=>t(),s.onerror=()=>a(new Error(`Failed to load ${e}`)),document.head.appendChild(s)})),scriptCache[e]}let itemIdCounter=0;function ensureItemIds(e){return e&&Array.isArray(e)?e.map((e,t)=>(e.id||(itemIdCounter++,e.id="item_"+Date.now()+"_"+itemIdCounter+"_"+t),e)):e}const sectionRegistry={settings:{id:"settings",name:"Settings",icon:"settings",maxInstances:1,allowMultiple:!1,hasDivider:!1,defaultData:{currencySymbol:"$",currencyPosition:"before",selectedFont:"font-1",textColor:"#000000",showBackground:!0,receiptWidth:320}},header:{id:"header",name:"Header",icon:"header",maxInstances:1,allowMultiple:!1,hasDivider:!0,defaultData:{logoUrl:"",headerAlignment:"center",logoSize:50,businessName:"Business Details",headerDivider:"---",showHeaderDivider:!0}},dateTime:{id:"dateTime",name:"Date & Time",icon:"calendar",maxInstances:1,allowMultiple:!1,hasDivider:!0,defaultData:{dateAlignment:"left",dateTime:"",dateDivider:"---",showDateDivider:!0}},twoColumn:{id:"twoColumn",name:"Two column information",icon:"columns",maxInstances:10,allowMultiple:!0,hasDivider:!0,defaultData:{customFields:[{label:"Table",value:"415",column:1},{label:"Server",value:"Rebecca",column:1},{label:"Guests",value:"2",column:2}],infoDivider:"---",showInfoDivider:!0}},items:{id:"items",name:"Items list",icon:"cart",maxInstances:1,allowMultiple:!1,hasDivider:!0,defaultData:{items:[{id:"item_"+Date.now()+"_1",quantity:1,name:"Americano",price:2.99},{id:"item_"+Date.now()+"_2",quantity:2,name:"Chocolate Chip Cookie",price:1.98},{id:"item_"+Date.now()+"_3",quantity:2,name:"Coke",price:1.5}],itemsDivider:"---",showItemsDivider:!0}},payment:{id:"payment",name:"Payment",icon:"payment",maxInstances:1,allowMultiple:!1,hasDivider:!0,defaultData:{taxRate:null,showTaxRate:!1,paymentType:"cash",paymentFields:[],paymentDivider:"---",showPaymentDivider:!0}},customMessage:{id:"customMessage",name:"Custom message",icon:"message",maxInstances:10,allowMultiple:!0,hasDivider:!0,defaultData:{customMessage:"THANK YOU\nHAVE A NICE DAY",messageAlignment:"center",messageBold:!1,messageDivider:"---",showMessageDivider:!1}},barcode:{id:"barcode",name:"Barcode",icon:"barcode",maxInstances:1,allowMultiple:!1,hasDivider:!1,defaultData:{barcodeEnabled:!0,barcodeSize:50,barcodeLength:50,barcodeValue:""}}};function advancedReceiptGeneratorV2(e=!1,t=null,a=!1,s=""){return{sections:[],nextInstanceId:1,sectionRegistry:sectionRegistry,addSectionModalOpen:!1,hasSubscription:Boolean(e),templateConfig:t,isAuthenticated:Boolean(a),templateName:s,draggedId:null,draggedOverId:null,showSaveTemplateModal:!1,saveTemplateName:"",saveTemplateDescription:"",saveTemplateError:"",saveTemplateSuccess:!1,saveTemplateLoading:!1,hasPendingSave:!1,showAutoSaveSuccess:!1,showPreview:!1,downloadingPdf:!1,downloadSuccessToast:!1,downloadJustCompleted:!1,showDownloadMenu:!1,downloadingFormat:null,autoSaveNotification:!1,lastAutoSave:null,autoSaveTimer:null,autoSaveDebounceTimer:null,checkPostLoginRedirect(){if("1"===new URLSearchParams(window.location.search).get("redirect_to_dashboard")){"true"===document.body.getAttribute("data-autosave-success")&&setTimeout(()=>{window.location.href="/dashboard"},500)}},autoSaveKey:null,hasRestoredFromAutoSave:!1,savedTemplateSlug:"",showRestoreModal:!1,pendingRestoreConfig:null,currentReceiptWidth:320,previewUpdating:!1,updateDebounceTimer:null,debouncedSections:[],hasTrackedFirstEdit:!1,getAutoSaveKey:()=>"receipt_autosave"+window.location.pathname.replace(/\//g,"_").replace(/-/g,"_"),getTemplateSlugFromUrl(){const e=window.location.pathname,t=e.match(/\/generate-([^-]+(?:-[^-]+)*)-receipt/);return t?t[1]:e.includes("/generate-advanced")?"advanced":""},init(){window.receiptGenerator=this,this.autoSaveKey=this.getAutoSaveKey(),window.addEventListener("store-template-for-save",()=>{this.storeTemplateForSave()}),this.checkForSavedReceipt();if(new URLSearchParams(window.location.search).has("load_template")&&sessionStorage.removeItem("pending_template_save"),this.checkPendingTemplateSave(),this.checkPostLoginRedirect(),this.hasPendingSave);else if(this.showRestoreModal&&this.pendingRestoreConfig)console.log("Loading saved receipt for preview - banner shown"),this.loadTemplate(this.pendingRestoreConfig),this.hasRestoredFromAutoSave=!0;else if(this.templateConfig)console.log("Loading template:",this.templateName||"custom"),this.loadTemplate(this.templateConfig);else{const e=this.createSection("settings",!0);e.data.selectedFont="font-1",e.data.textColor="#000000",e.data.currencyFormat="$X",e.data.receiptWidth=320;const t=this.createSection("header",!0);t.data.logoUrl="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><circle cx="40" cy="40" r="35" fill="#000000" stroke="#333333" stroke-width="2"/><text x="40" y="50" font-family="Arial" font-size="32" font-weight="bold" fill="#ffffff" text-anchor="middle">SE</text></svg>'),t.data.logoSize=35,t.data.businessName="STORE EXPRESS",t.data.line1="123 Main Street",t.data.line2="Springfield, IL 62701",t.data.line3="(555) 123-4567",t.data.headerAlignment="center";const a=this.createSection("dateTime",!0);a.data.dateTime=(new Date).toLocaleString("en-US",{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),a.data.dateAlignment="center";const s=this.createSection("items",!1);s.data.items=[{id:"item_1",quantity:2,name:"Wireless Mouse",price:24.99},{id:"item_2",quantity:1,name:"USB-C Cable (6ft)",price:12.99},{id:"item_3",quantity:1,name:"Phone Screen Protector",price:9.99},{id:"item_4",quantity:3,name:"AA Batteries (4-pack)",price:8.99}];const i=this.createSection("payment",!0);i.data.taxRate=8.5,i.data.showTaxRate=!0,i.data.paymentType="card",i.data.paymentFields=[{label:"Card number",value:"**** **** **** 4922"},{label:"Card type",value:"Debit"},{label:"Card entry",value:"Chip"},{label:"Transaction #",value:"458721"},{label:"Cashier",value:"Sarah M."},{label:"Register",value:"03"},{label:"REWARDS MEMBER",value:"#SE892341"},{label:"Points earned",value:"45"},{label:"Total points",value:"1,245"}];const o=this.createSection("customMessage",!0);o.data.customMessage="Thank you for shopping with us!\n\nReturns accepted within 30 days with receipt.\nFor assistance, call us at (555) 123-4567",o.data.messageAlignment="center";const n=this.createSection("customMessage",!0);n.data.customMessage="Visit us online at StoreExpress.com for exclusive deals!\n\nSign up for our rewards program and earn 1 point per dollar spent. New members get 500 bonus points!\n\nJoin our email list for 10% off your next purchase.\n\nFollow us @StoreExpress on social media for daily deals, giveaways, and special promotions.\n\nShop with confidence - 100% satisfaction guaranteed or your money back.",n.data.messageAlignment="center";const r=this.createSection("barcode",!0);r.data.barcodeValue="458721",this.sections=[e,t,a,s,i,o,n,r]}this.startAutoSave(),this.$nextTick(()=>{this.debouncedSections=JSON.parse(JSON.stringify(this.sections))}),this.$watch(()=>JSON.stringify(this.sections),()=>{this.triggerDebouncedPreviewUpdate(),this.triggerDebouncedAutoSave();const e=this.sections.find(e=>"settings"===e.type);e&&(this.currentReceiptWidth=e.data.receiptWidth||320)}),window.addEventListener("beforeunload",()=>{console.log("âš ï¸ User is leaving page - forcing auto-save"),this.autoSave(),this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.updateDebounceTimer&&clearTimeout(this.updateDebounceTimer),this.autoSaveDebounceTimer&&clearTimeout(this.autoSaveDebounceTimer)}),document.addEventListener("visibilitychange",()=>{document.hidden&&(console.log("ðŸ“± Tab hidden - forcing auto-save"),this.autoSave())}),setTimeout(()=>{this.renderBarcodes()},500)},triggerDebouncedPreviewUpdate(){this.previewUpdating=!0,this.updateDebounceTimer&&clearTimeout(this.updateDebounceTimer),this.updateDebounceTimer=setTimeout(()=>{this.debouncedSections=JSON.parse(JSON.stringify(this.sections)),this.previewUpdating=!1,this.renderBarcodes(),window.posthog&&!this.hasTrackedFirstEdit&&(posthog.capture("first_field_edited"),this.hasTrackedFirstEdit=!0)},300)},loadTemplate(e){if(this.sections=[],e.sections&&Array.isArray(e.sections)){if(e.settings){const t=this.createSection("settings");Object.assign(t.data,e.settings),this.sections.push(t)}if(e.header){const t=this.createSection("header");Object.assign(t.data,e.header),this.sections.push(t)}e.sections.forEach(e=>{const t=this.createSection(e.type);t&&e.data&&(Object.assign(t.data,e.data),"items"===t.type&&t.data.items&&(t.data.items=ensureItemIds(t.data.items)),this.sections.push(t))})}else{if(e.settings){const t=this.createSection("settings");Object.assign(t.data,e.settings),this.sections.push(t)}if(e.header){const t=this.createSection("header");Object.assign(t.data,e.header),this.sections.push(t)}if(e.dateTime){const t=this.createSection("dateTime");Object.assign(t.data,e.dateTime),this.sections.push(t)}if(e.twoColumn&&e.twoColumn.length>0){const t=this.createSection("twoColumn");t.data.customFields=e.twoColumn.map((e,t)=>({label:e.label,value:e.value,column:1})),this.sections.push(t)}if(e.customMessages&&e.customMessages.length>0&&e.customMessages.forEach(e=>{const t=this.createSection("customMessage");Object.assign(t.data,e),this.sections.push(t)}),e.items&&e.items.length>0){const t=this.createSection("items");t.data.items=ensureItemIds(e.items.map(e=>({...e,name:e.name,price:String(e.price),quantity:e.quantity||"",indent:e.indent||!1}))),this.sections.push(t)}if(e.payment){const t=this.createSection("payment");Object.assign(t.data,e.payment),this.sections.push(t)}if(e.customMessages2&&e.customMessages2.length>0&&e.customMessages2[0]){const t=this.createSection("customMessage");Object.assign(t.data,e.customMessages2[0]),this.sections.push(t)}if(e.barcode){const t=this.createSection("barcode");Object.assign(t.data,e.barcode),this.sections.push(t)}if(e.customMessages2&&e.customMessages2.length>1)for(let t=1;t<e.customMessages2.length;t++){const a=this.createSection("customMessage");Object.assign(a.data,e.customMessages2[t]),this.sections.push(a)}}this.sections.forEach(e=>{"items"===e.type&&e.data.items&&(e.data.items=ensureItemIds(e.data.items))});const t=this.sections.find(e=>"settings"===e.type);t&&(null==t.data.receiptWidth&&(t.data.receiptWidth=320,console.log("Migrated: added receiptWidth to settings")),this.currentReceiptWidth=t.data.receiptWidth),console.log("Template loaded:",this.sections.length,"sections")},createSection(e,t=!0){const a=this.sectionRegistry[e];return a?{instanceId:this.nextInstanceId++,type:e,collapsed:t,data:JSON.parse(JSON.stringify(a.defaultData))}:(console.error("Unknown section type:",e),null)},addSection(e){const t=this.sectionRegistry[e];if(!t)return;if(this.sections.filter(t=>t.type===e).length>=t.maxInstances)return void alert(`Maximum ${t.maxInstances} ${t.name} section(s) allowed`);const a=this.createSection(e,!1);this.sections.push(a),this.addSectionModalOpen=!1},removeSection(e){const t=this.sections.find(t=>t.instanceId===e);if(!t)return;if(["settings","items","payment"].includes(t.type)&&!confirm(`Are you sure you want to remove the ${this.getSectionTemplate(t.type).name} section? This may affect your receipt.`))return;const a=this.sections.findIndex(t=>t.instanceId===e);a>-1&&this.sections.splice(a,1)},toggleSection(e){const t=this.sections.find(t=>t.instanceId===e);t&&(t.collapsed=!t.collapsed)},moveSectionUp(e){const t=this.sections.findIndex(t=>t.instanceId===e);if(t<=0)return;const a=this.sections[t];this.sections[t]=this.sections[t-1],this.sections[t-1]=a,this.sections=[...this.sections]},moveSectionDown(e){const t=this.sections.findIndex(t=>t.instanceId===e);if(t<0||t>=this.sections.length-1)return;const a=this.sections[t];this.sections[t]=this.sections[t+1],this.sections[t+1]=a,this.sections=[...this.sections]},dragHandleActive:!1,isDraggingNow:!1,isMobile:window.innerWidth<1024,vibrate(e){navigator.vibrate&&navigator.vibrate(e)},handleDragStart(e,t){this.dragHandleActive=!0,this.isDraggingNow=!0},dragStartFromHandle(e,t){const a=e.target.tagName.toLowerCase();["input","select","textarea","button","label"].includes(a)||e.target.closest("input, select, textarea, button, label")?e.preventDefault():(this.draggedId=t.instanceId,this.isDraggingNow=!0,e.dataTransfer.effectAllowed="move",navigator.vibrate&&navigator.vibrate(50))},dragOver(e,t){if(this.draggedId&&t){if(this.draggedOverId!==t.instanceId&&(this.draggedOverId=t.instanceId,this.draggedId!==t.instanceId)){const e=this.sections.findIndex(e=>e.instanceId===this.draggedId),a=this.sections.findIndex(e=>e.instanceId===t.instanceId);if(-1!==e&&-1!==a&&e!==a){const t=this.sections[e];this.sections.splice(e,1),this.sections.splice(a,0,t),this.sections=[...this.sections]}}e.dataTransfer.dropEffect="move",e.preventDefault()}},dragLeave(){this.draggedOverId=null},dragDrop(e,t){if(e.preventDefault(),!this.draggedId||!t)return this.draggedId=null,void(this.draggedOverId=null);navigator.vibrate&&navigator.vibrate([30,50,30]),this.draggedId=null,this.draggedOverId=null},dragEnd(e){this.draggedId=null,this.draggedOverId=null,requestAnimationFrame(()=>{this.isDraggingNow=!1}),navigator.vibrate&&navigator.vibrate(30)},getSectionTemplate(e){return this.sectionRegistry[e]},canAddSection(e){const t=this.sectionRegistry[e];if(!t)return!1;return this.sections.filter(t=>t.type===e).length<t.maxInstances},get globalSettings(){const e=this.sections.find(e=>"settings"===e.type);return e?e.data:{currencyFormat:"$X",selectedFont:"font-1",textColor:"#000000",showBackground:!0,receiptWidth:320}},get subtotal(){return this.sections.filter(e=>"items"===e.type).reduce((e,t)=>e+t.data.items.reduce((e,t)=>e+(parseFloat(t.price)||0)*(parseInt(t.quantity)||0),0),0)},get tax(){const e=this.sections.find(e=>"payment"===e.type),t=e&&parseFloat(e.data.taxRate)||0;return e&&e.data.showTaxRate&&t>0?this.subtotal*(t/100):0},get total(){const e=this.sections.find(e=>"payment"===e.type),t=e&&parseFloat(e.data.taxRate)||0;return e&&e.data.showTaxRate&&t>0?this.subtotal+this.tax:this.subtotal},formatCurrency(e){const t=this.globalSettings,a=t.currencySymbol??"$",s=t.currencyPosition||"before",i=e.toFixed(2);if(!a||""===a.trim())return i;switch(s){case"before":default:return a+i;case"after":return i+a;case"after-space":return i+" "+a}},formatPrice(e){return this.formatCurrency(e)},calculateSubtotal(){return this.subtotal},getDivider(e){const t=(this.currentReceiptWidth||320)-64,a=Math.max(15,Math.ceil(t/6)+2);return({"---":"-","===":"=","...":".",":::":":","***":"*"}[e]||"-").repeat(a)},generateBarcode(e=50){const t=Math.floor(e/10);let a="";for(let e=0;e<t;e++)a+=Math.floor(10*Math.random());return a||"0"},getBarcodeValue(e){if(e.data.barcodeValue)return e.data.barcodeValue;const t=this.generateBarcode(e.data.barcodeLength||50);return e.data.barcodeValue=t,t},refreshBarcode(e){const t=this.sections.find(t=>t.instanceId===e);t&&"barcode"===t.type&&(t.data.barcodeValue=this.generateBarcode(t.data.barcodeLength||50),this.renderBarcodes())},renderBarcodes(){setTimeout(()=>{if("undefined"==typeof JsBarcode)return void console.warn("JsBarcode not loaded yet");document.querySelectorAll('svg[id^="barcode-"]').forEach(e=>{const t=e.parentElement?.querySelector(".text-center.text-xs"),a=t?t.textContent.trim():"0",s=this.sections.find(t=>e.id===`barcode-${t.instanceId}`),i=s?.data?.barcodeSize||50;try{JsBarcode(`#${e.id}`,a,{format:"CODE128",width:2,height:parseInt(i),displayValue:!1,margin:0,background:"#ffffff",lineColor:"#000000"})}catch(t){console.error("JsBarcode render error for",e.id,":",t)}})},100)},addItem(e){const t=this.sections.find(t=>t.instanceId===e);if(t&&"items"===t.type){const e="item_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);t.data.items.push({id:e,quantity:1,name:"",price:0})}},removeItem(e,t){const a=this.sections.find(t=>t.instanceId===e);a&&"items"===a.type&&a.data.items.splice(t,1)},addCustomField(e,t=1){const a=this.sections.find(t=>t.instanceId===e);a&&"twoColumn"===a.type&&a.data.customFields.push({label:"",value:"",column:t})},removeCustomField(e,t){const a=this.sections.find(t=>t.instanceId===e);a&&"twoColumn"===a.type&&a.data.customFields.splice(t,1)},addPaymentField(e){const t=this.sections.find(t=>t.instanceId===e);t&&"payment"===t.type&&t.data.paymentFields.push({label:"",value:""})},removePaymentField(e,t){const a=this.sections.find(t=>t.instanceId===e);a&&"payment"===a.type&&a.data.paymentFields.splice(t,1)},uploadLogo(e,t){const a=this.sections.find(t=>t.instanceId===e);if(a&&"header"===a.type){const e=t.target.files[0];if(e){const t=new FileReader;t.onload=e=>{a.data.logoUrl=e.target.result},t.readAsDataURL(e)}}},validateReceipt(){const e=[];this.sections.filter(e=>"items"===e.type).forEach(t=>{t.data.items.forEach((t,a)=>{t.name&&""!==t.name.trim()||e.push(`Item ${a+1}: Name is required`),(isNaN(t.price)||t.price<0)&&e.push(`Item ${a+1}: Price must be a valid number`),(isNaN(t.quantity)||t.quantity<1)&&e.push(`Item ${a+1}: Quantity must be at least 1`)})});return this.sections.filter(e=>"twoColumn"===e.type).forEach(t=>{t.data.customFields.forEach((t,a)=>{t.label&&!t.value&&e.push(`Two-column field "${t.label}": Value is required`)})}),e},async downloadReceipt(){console.log("ðŸ“„ downloadReceipt() started");const e=document.getElementById("receipt-preview");if(!e)return console.error("ðŸ“„ Receipt preview element not found!"),void alert("Receipt preview not found");console.log("ðŸ“„ Receipt preview found:",e),this.downloadingPdf=!0;try{console.log("ðŸ“„ Loading libraries..."),"undefined"==typeof html2canvas&&(console.log("ðŸ“„ Loading html2canvas..."),await loadScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js")),void 0===window.jspdf&&(console.log("ðŸ“„ Loading jsPDF..."),await loadScript("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js")),console.log("ðŸ“„ Libraries loaded successfully");const{jsPDF:t}=window.jspdf;await new Promise(e=>setTimeout(e,300)),console.log("ðŸ“„ Capturing receipt with html2canvas...");const a=await html2canvas(e,{scale:2,useCORS:!0,backgroundColor:"#ffffff",allowTaint:!0,logging:!1,ignoreElements:e=>{if("watermark-overlay"===e.id)return!0;if(e.classList&&e.classList.contains("watermark-overlay"))return!0;const t=e.getAttribute&&e.getAttribute("style");return!(!t||!t.includes("background-image"))||(!!(e.style&&e.style.backgroundImage&&e.style.backgroundImage.includes("url("))||!(!e.classList||!e.classList.contains("z-20")))}});console.log("ðŸ“„ Canvas captured:",a.width,"x",a.height);const s=a.toDataURL("image/png"),i=.264583*(this.currentReceiptWidth||e.offsetWidth||320),o=i*a.height/a.width,n=o+12,r=new t({orientation:"p",unit:"mm",format:[i,n]});r.addImage(s,"PNG",0,0,i,o),r.setFontSize(7),r.setTextColor(180,180,180),r.text("fake receipt",2,n-2);const c=r.output("arraybuffer"),d=new Blob([c],{type:"application/pdf"});if(!d||0===d.size)throw new Error("PDF generation failed - empty result");const l=this.templateName||"custom",m=this.sections.find(e=>"header"===e.type),h=m?.data?.businessName||"";console.log("ðŸ“„ Sending PDF to server for watermarking...");const u=new FormData;u.append("pdf",d,"receipt.pdf"),u.append("template_type",l),u.append("store_name",h);const p=await fetch("/api/apply-watermark",{method:"POST",body:u});if(console.log("ðŸ“„ Server response status:",p.status),!p.ok){const e=await p.text();throw console.error("ðŸ“„ Server error:",e),new Error(`Server watermarking failed: ${p.status}`)}console.log("ðŸ“„ Getting watermarked PDF blob...");const g=await p.blob();console.log("ðŸ“„ Watermarked blob size:",g.size);const v=URL.createObjectURL(g);console.log("ðŸ“„ Creating download link...");const f=document.createElement("a");f.href=v,f.download="receipt.pdf",document.body.appendChild(f),f.click(),console.log("ðŸ“„ Download triggered!"),document.body.removeChild(f),URL.revokeObjectURL(v),this.downloadSuccessToast=!0,setTimeout(()=>this.downloadSuccessToast=!1,3e3)}catch(e){console.error("PDF error:",e),alert("Failed to download. Please try again.")}finally{this.downloadingPdf=!1,this.downloadingFormat=null}},async downloadImage(e){const t={preview:{maxWidth:200,scale:1.5,requiresPro:!1},standard:{maxWidth:750,scale:1.5,requiresPro:!0},hd:{maxWidth:1500,scale:3,requiresPro:!0}}[e];if(!t)return void alert("Invalid quality setting");if(t.requiresPro&&!this.hasSubscription)return void(window.location.href="/pricing");const a=document.getElementById("receipt-preview");if(a){this.downloadingFormat=e,this.showDownloadMenu=!1;try{"undefined"==typeof html2canvas&&await loadScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"),await new Promise(e=>setTimeout(e,300));const s=a.offsetWidth||320,i=t.maxWidth/s,o=Math.max(1,Math.min(i,t.scale)),n=await html2canvas(a,{scale:o,useCORS:!0,backgroundColor:"#ffffff",allowTaint:!0,logging:!1,ignoreElements:e=>{if("watermark-overlay"===e.id)return!0;if(e.classList&&e.classList.contains("watermark-overlay"))return!0;const t=e.getAttribute&&e.getAttribute("style");return!(!t||!t.includes("background-image"))||(!!(e.style&&e.style.backgroundImage&&e.style.backgroundImage.includes("url("))||!(!e.classList||!e.classList.contains("z-20")))}});if(!this.hasSubscription){const e=n.getContext("2d");e.save(),e.globalAlpha=.18;const t=Math.max(n.width,n.height)/500,a=Math.max(10,Math.round(14*t)),s=Math.max(40,Math.round(60*t)),i=Math.max(80,Math.round(120*t));e.font=`bold ${a}px Arial`,e.fillStyle="#555555",e.translate(n.width/2,n.height/2),e.rotate(-30*Math.PI/180);for(let t=1.5*-n.height;t<1.5*n.height;t+=s)for(let a=1.5*-n.width;a<1.5*n.width;a+=i)e.fillText("RECEIPTMAKE",a,t);e.restore()}try{const t=n.toDataURL("image/png"),a=document.createElement("a");a.href=t,a.download=`receipt-${e}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),this.downloadSuccessToast=!0,setTimeout(()=>this.downloadSuccessToast=!1,3e3)}catch(e){throw console.error("Canvas export error:",e),new Error("Could not export image. Try removing external logos.")}}catch(e){console.error("Image download error:",e),alert("Failed to download. Please try again.")}finally{this.downloadingFormat=null}}else alert("Receipt preview not found")},async downloadPDF(){if(console.log("ðŸ“„ downloadPDF called, hasSubscription:",this.hasSubscription),!this.hasSubscription)return console.log("ðŸ“„ No subscription, redirecting to pricing"),void(window.location.href="/pricing");try{console.log("ðŸ“„ Starting PDF download..."),await this.downloadReceipt(),console.log("ðŸ“„ PDF download completed successfully")}catch(e){console.error("ðŸ“„ PDF download error:",e)}},resetForm(){confirm("âš ï¸ Are you sure?\n\nThis will permanently delete all your work.\n\nThis cannot be undone.")&&(this.clearAutoSave(),location.reload())},startAutoSave(){this.autoSaveTimer=setInterval(()=>{this.autoSave()},1e4)},triggerDebouncedAutoSave(){this.autoSaveDebounceTimer&&clearTimeout(this.autoSaveDebounceTimer),this.autoSaveDebounceTimer=setTimeout(()=>{this.autoSave()},500)},autoSave(){try{if(0===this.sections.length)return;const e=this.getTemplateSlugFromUrl(),t={sections:JSON.parse(JSON.stringify(this.sections)),nextInstanceId:this.nextInstanceId,timestamp:(new Date).toISOString(),savedAt:(new Date).toLocaleTimeString(),templateName:this.templateName||"",templateSlug:e,url:window.location.pathname};localStorage.setItem(this.autoSaveKey,JSON.stringify(t)),this.lastAutoSave=t.savedAt,console.log("âœ“ Receipt auto-saved at",this.lastAutoSave,"with",this.sections.length,"sections")}catch(e){console.error("âŒ Auto-save error:",e)}},clearAutoSave(){localStorage.removeItem(this.autoSaveKey),this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null),this.autoSaveDebounceTimer&&(clearTimeout(this.autoSaveDebounceTimer),this.autoSaveDebounceTimer=null)},handleSaveTemplate(){if(this.validateReceipt().length>0)alert("Please fix validation errors before saving template");else if(this.isAuthenticated)this.showSaveTemplateModal=!0;else{this.storeTemplateForSave();const e=this.sections.find(e=>"header"===e.type),t=this.sections.find(e=>"dateTime"===e.type),a=this.sections.find(e=>"items"===e.type);window.dispatchEvent(new CustomEvent("open-login-modal",{detail:{businessName:e?.data.businessName||"Your Business",dateTime:t?.data.dateTime||(new Date).toLocaleString(),items:a?.data.items||[],total:this.calculateSubtotal()}}))}},async handleRemoveWatermark(){const e={sections:this.sections.map(e=>({type:e.type,data:e.data,collapsed:e.collapsed}))},t=this.sections.find(e=>"header"===e.type);let a=t?.data.businessName||"Business";"Business"===a&&this.templateName&&(a=this.templateName);const s=a.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()),i={intent:"remove_watermark",name:s,description:"Auto-saved before removing watermark",config:e};try{const t=this.getTemplateSlugFromUrl();localStorage.setItem("savedReceipt",JSON.stringify({config:e,timestamp:(new Date).toISOString(),name:s,templateSlug:t}));if(!(await fetch("/api/store-pending-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).ok)throw new Error("Failed to store receipt");window.location.href="/pricing"}catch(e){console.error("Error storing pending receipt:",e),alert("Failed to store receipt. Please try again.")}},storeTemplateForSave(){const e=sessionStorage.getItem("pending_template_save");if(e)try{if("remove_watermark"===JSON.parse(e).intent)return}catch(e){}const t={intent:"save_template",name:"Template 1",description:"",config:{sections:this.sections.map(e=>({type:e.type,data:e.data,collapsed:e.collapsed}))},timestamp:Date.now(),nextUrl:window.location.pathname,autoSave:!0};sessionStorage.setItem("pending_template_save",JSON.stringify(t))},checkPendingTemplateSave(){if(!this.isAuthenticated)return;const e=sessionStorage.getItem("pending_template_save");if(e)try{const t=JSON.parse(e);if(!["save_template","remove_watermark"].includes(t.intent))return void sessionStorage.removeItem("pending_template_save");if(Date.now()-(t.timestamp||0)>6e5)return void sessionStorage.removeItem("pending_template_save");if(!t.config||!t.config.sections||!t.name)return void sessionStorage.removeItem("pending_template_save");this.loadTemplate(t.config),this.hasPendingSave=!0,this.$nextTick(()=>{t.autoSave?this.autoSaveTemplateAndRedirect(t.name,t.description||"","remove_watermark"===t.intent?"/pricing":null):(this.saveTemplateName=t.name,this.saveTemplateDescription=t.description||"",this.showSaveTemplateModal=!0),this.initSortable(),sessionStorage.removeItem("pending_template_save")})}catch(e){console.error("Error processing pending template save:",e),sessionStorage.removeItem("pending_template_save")}},checkForSavedReceipt(){if(new URLSearchParams(window.location.search).has("load_template"))return;const e=this.getTemplateSlugFromUrl(),t=localStorage.getItem(this.autoSaveKey);if(t)try{const a=JSON.parse(t),s=new Date(a.timestamp),i=new Date;if((i-s)/864e5>7)return void localStorage.removeItem(this.autoSaveKey);this.savedTemplateSlug=a.templateSlug||"";const o=a.templateSlug||"";return o!==e?void console.log(`Auto-save template "${o}" doesn't match current template "${e}" - skipping restore`):(this.pendingRestoreConfig={sections:a.sections,nextInstanceId:a.nextInstanceId,savedAt:a.savedAt||"earlier"},this.showRestoreModal=!0,void console.log("Found saved receipt for matching template - showing restore modal"))}catch(e){console.error("Error loading auto-save:",e),localStorage.removeItem(this.autoSaveKey)}const a=localStorage.getItem("savedReceipt");if(a)try{const t=JSON.parse(a),s=new Date(t.timestamp),i=new Date;if((i-s)/864e5>7)return void localStorage.removeItem("savedReceipt");const o=t.templateSlug||"";if(o!==e)return void console.log(`Saved receipt template "${o}" doesn't match current template "${e}" - skipping restore`);t.config&&(this.pendingRestoreConfig={sections:t.config.sections,nextInstanceId:t.config.nextInstanceId||1,savedAt:"earlier"},this.showRestoreModal=!0,console.log("Found saved receipt for matching template - showing restore modal"))}catch(e){console.error("Error restoring saved receipt:",e),localStorage.removeItem("savedReceipt")}},handleRestoreContinue(){console.log("User chose to continue with saved receipt"),this.showRestoreModal=!1,this.pendingRestoreConfig=null},handleRestoreStartFresh(){this.clearAutoSave(),localStorage.removeItem("savedReceipt"),this.templateConfig?(this.loadTemplate(this.templateConfig),console.log("User chose to start fresh - loading template")):(this.createDefaultSections(),console.log("User chose to start fresh - using defaults")),this.showRestoreModal=!1,this.pendingRestoreConfig=null,this.$nextTick(()=>{this.debouncedSections=JSON.parse(JSON.stringify(this.sections))})},createDefaultSections(){const e=this.createSection("settings",!0);e.data.selectedFont="font-1",e.data.textColor="#000000",e.data.currencyFormat="$X";const t=this.createSection("header",!0);t.data.logoUrl="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><circle cx="40" cy="40" r="35" fill="#000000" stroke="#333333" stroke-width="2"/><text x="40" y="50" font-family="Arial" font-size="32" font-weight="bold" fill="#ffffff" text-anchor="middle">SE</text></svg>'),t.data.logoSize=35,t.data.businessName="STORE EXPRESS",t.data.line1="123 Main Street",t.data.line2="Springfield, IL 62701",t.data.line3="(555) 123-4567",t.data.headerAlignment="center";const a=this.createSection("dateTime",!0);a.data.dateTime=(new Date).toLocaleString("en-US",{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),a.data.dateAlignment="center";const s=this.createSection("items",!1);s.data.items=[{id:"item_1",quantity:2,name:"Wireless Mouse",price:24.99},{id:"item_2",quantity:1,name:"USB-C Cable (6ft)",price:12.99},{id:"item_3",quantity:1,name:"Phone Screen Protector",price:9.99},{id:"item_4",quantity:3,name:"AA Batteries (4-pack)",price:8.99}];const i=this.createSection("payment",!0);i.data.taxRate=8.5,i.data.showTaxRate=!0,i.data.paymentType="card",i.data.paymentFields=[{label:"Card number",value:"**** **** **** 4922"},{label:"Card type",value:"Debit"},{label:"Card entry",value:"Chip"},{label:"Transaction #",value:"458721"},{label:"Cashier",value:"Sarah M."},{label:"Register",value:"03"},{label:"REWARDS MEMBER",value:"#SE892341"},{label:"Points earned",value:"45"},{label:"Total points",value:"1,245"}];const o=this.createSection("customMessage",!0);o.data.customMessage="Thank you for shopping with us!\n\nReturns accepted within 30 days with receipt.\nFor assistance, call us at (555) 123-4567",o.data.messageAlignment="center";const n=this.createSection("customMessage",!0);n.data.customMessage="Visit us online at StoreExpress.com for exclusive deals!\n\nSign up for our rewards program and earn 1 point per dollar spent. New members get 500 bonus points!\n\nJoin our email list for 10% off your next purchase.\n\nFollow us @StoreExpress on social media for daily deals, giveaways, and special promotions.\n\nShop with confidence - 100% satisfaction guaranteed or your money back.",n.data.messageAlignment="center";const r=this.createSection("barcode",!0);r.data.barcodeValue="458721",this.sections=[e,t,a,s,i,o,n,r]},async saveTemplate(){if(this.saveTemplateError="",this.saveTemplateSuccess=!1,this.saveTemplateLoading=!0,!this.saveTemplateName.trim())return this.saveTemplateError="Template name is required",void(this.saveTemplateLoading=!1);if(this.validateReceipt().length>0)return this.saveTemplateError="Please fix validation errors before saving",void(this.saveTemplateLoading=!1);const e={sections:this.sections.map(e=>({type:e.type,data:e.data,collapsed:e.collapsed}))};if(!this.isAuthenticated){const t={intent:"save_template",name:this.saveTemplateName.trim(),description:this.saveTemplateDescription.trim(),config:e,timestamp:Date.now(),nextUrl:window.location.pathname,autoSave:!0};sessionStorage.setItem("pending_template_save",JSON.stringify(t)),this.showSaveTemplateModal=!1;const a=this.sections.find(e=>"header"===e.type),s=this.sections.find(e=>"dateTime"===e.type),i=this.sections.find(e=>"items"===e.type);return void window.dispatchEvent(new CustomEvent("open-login-modal",{detail:{businessName:a?.data.businessName||"Your Business",dateTime:s?.data.dateTime||(new Date).toLocaleString(),items:i?.data.items||[],total:this.calculateSubtotal()}}))}try{const t=await fetch("/api/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:this.saveTemplateName.trim(),description:this.saveTemplateDescription.trim(),template_type:"custom",config_json:e})}),a=await t.json();if(!a.success)throw new Error(a.error||"Failed to save template");this.saveTemplateSuccess=!0,this.saveTemplateLoading=!1,setTimeout(()=>{this.showSaveTemplateModal=!1,this.saveTemplateName="",this.saveTemplateDescription="",this.saveTemplateSuccess=!1,window.location.href="/dashboard"},1500)}catch(e){console.error("Error saving template:",e),this.saveTemplateError=e.message||"Failed to save template. Please try again.",this.saveTemplateLoading=!1}},async autoSaveTemplate(e,t,a=!1){const s={sections:this.sections.map(e=>({type:e.type,data:e.data,collapsed:e.collapsed}))};try{const i=await fetch("/api/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.trim(),description:t.trim(),template_type:"custom",config_json:s})}),o=await i.json();if(!o.success)throw new Error(o.error||"Failed to save template");this.showAutoSaveSuccess=!0,a?setTimeout(()=>{window.location.href="/dashboard"},1500):setTimeout(()=>{this.showAutoSaveSuccess=!1},5e3)}catch(e){console.error("Error auto-saving template:",e),alert("Template loaded but failed to save automatically. Please save manually from the Save button.")}},async autoSaveTemplateAndRedirect(e,t,a){const s={sections:this.sections.map(e=>({type:e.type,data:e.data,collapsed:e.collapsed}))};try{const i=await fetch("/api/templates",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.trim(),description:t.trim(),template_type:"custom",config_json:s})}),o=await i.json();if(!o.success)throw new Error(o.error||"Failed to save template");this.showAutoSaveSuccess=!0,a?setTimeout(()=>{window.location.href=a},1500):setTimeout(()=>{this.showAutoSaveSuccess=!1},5e3)}catch(e){console.error("Error auto-saving template:",e),a?(alert("Template loaded but failed to save automatically. You can save it later from your dashboard."),setTimeout(()=>{window.location.href=a},2e3)):alert("Template loaded but failed to save automatically. Please save manually from the Save button.")}}}}window.advancedReceiptGeneratorV2=advancedReceiptGeneratorV2,console.log("Advanced receipt generator loaded and exported to window");